#!/bin/bash

# ==============================================================================
# ZT BUNKER: TOTAL EMERGENCY RESTORE (V3.1 - MASTER STANDARD)
# –†–µ–∂–∏–º: ‡§°‡§ø‡§ú‡§æ—Å—Ç–µ—Ä ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä (Disaster Recovery)
# ==============================================================================

set -euo pipefail
# –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (Rule #3)
exec 9>/var/lock/zt-restore.lock
if ! flock -n 9; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —É–∂–µ –∑–∞–ø—É—â–µ–Ω –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º."
    exit 1
fi

# --- –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ---
REPO_URL="git@github.com:kukoboris/bunker-iac.git"
IAC_DIR="/opt/bunker-iac"
LOG_FILE="/var/log/zt-restore.log"
BORG_SSH_COMMAND="ssh -p 23 -o StrictHostKeyChecking=accept-new"

# –ü–ª–∞–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
# –§–æ—Ä–º–∞—Ç: "APP:CONTAINER:DUMP_FILE:RESTORE_CMD"
RECOVERY_PLAN=(
    "n8n:n8n-n8n-db-1:n8n_pg_dump.sql.gz:psql -U n8n_admin -d n8n_db"
    "forgejo:forgejo-db:forgejo_pg_dump.sql.gz:psql -U forgejo -d forgejo"
    "LibreChat:chat-mongodb:mongo_dump.gz:mongorestore --archive --gzip --drop"
    "LibreChat:vectordb:pg_dump.sql.gz:psql -U myuser -d postgres"
)

# --- –£—Ç–∏–ª–∏—Ç—ã –≤—ã–≤–æ–¥–∞ ---
log() { echo -e "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"; }
print_warning() { echo -e "\e[33m‚ö†Ô∏è $1\e[0m"; }
print_error()   { echo -e "\e[31m‚ùå $1\e[0m"; }
print_info()    { echo -e "\e[34m‚ÑπÔ∏è $1\e[0m"; }
print_success() { echo -e "\e[32m‚úÖ $1\e[0m"; }

error_exit() {
    log "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: $1"
    [[ -f "/usr/local/bin/telegram-send" ]] && /usr/local/bin/telegram-send "üö® <b>ZT BUNKER: RECOVERY FAILED!</b>\n\n–û—à–∏–±–∫–∞: <code>$1</code>" || true
    exit 1
}

wait_for_container() {
    local container=$1
    local timeout=60
    local elapsed=0
    log "‚è≥ –û–∂–∏–¥–∞—é –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ $container..."
    while [ $elapsed -lt $timeout ]; do
        if docker inspect -f '{{.State.Running}}' "$container" &>/dev/null; then
            local health
            health=$(docker inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{else}}running{{end}}' "$container")
            if [[ "$health" == "healthy" || "$health" == "running" ]]; then
                log "  ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä $container –≥–æ—Ç–æ–≤."
                return 0
            fi
        fi
        sleep 2
        elapsed=$((elapsed + 2))
    done
    error_exit "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä $container –Ω–µ –ø–æ–¥–Ω—è–ª—Å—è –∑–∞ $timeout —Å–µ–∫—É–Ω–¥."
}

cleanup() {
    log "üßπ –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞..."
    rm -f /opt/*.gz /opt/*.sql || true
}
trap cleanup EXIT

# ==============================================================================
# üèó –°–¢–ê–î–ò–Ø 0: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ SSH
# ==============================================================================
log "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ TOTAL RECOVERY..."
[[ $EUID -ne 0 ]] && error_exit "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç –∏–º–µ–Ω–∏ root!"

log "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
apt-get update -qq && apt-get install -y -qq git curl docker.io docker-compose-v2 >/dev/null

# –†–µ—à–∞–µ–º –≤–æ–ø—Ä–æ—Å —Å docker-compose vs docker compose
if ! command -v docker-compose &>/dev/null; then
    ln -s /usr/libexec/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose || true
fi

# –ü–†–û–í–ï–†–ö–ê –§–ò–ó–ò–ß–ï–°–ö–û–ì–û –ö–õ–Æ–ß–ê
if [[ ! -f ~/.ssh/id_ed25519 ]]; then
    print_warning "–£ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ SSH –∫–ª—é—á–∞."
    echo -e "\n\e[34m–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\e[0m"
    echo "1) –í—Å—Ç–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á –∏–∑ 1Password (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)"
    echo "2) –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å"
    read -rp "–í–∞—à –≤—ã–±–æ—Ä [1/2]: " SSH_CHOICE

    mkdir -p ~/.ssh && chmod 700 ~/.ssh
    if [[ "$SSH_CHOICE" == "1" ]]; then
        echo -e "\e[34m–í—Å—Ç–∞–≤—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ü–†–ò–í–ê–¢–ù–û–ì–û –∫–ª—é—á–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+D:\e[0m"
        cat > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
    else
        ssh-keygen -t ed25519 -C "Bunker-Restore-$(hostname)" -f ~/.ssh/id_ed25519 -N ""
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ GitHub
while true; do
    if ssh -i ~/.ssh/id_ed25519 -o BatchMode=yes -o StrictHostKeyChecking=accept-new -T git@github.com 2>&1 | grep -q "successfully authenticated"; then
        log "‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π SSH –∫–ª—é—á –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ GitHub."
        break
    fi
    print_error "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ GitHub!"
    echo -e "\e[34m–î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –ü–£–ë–õ–ò–ß–ù–´–ô –∫–ª—é—á –≤ GitHub Deploy Keys:\e[0m"
    cat ~/.ssh/id_ed25519.pub
    read -rp "–ù–∞–∂–º–∏—Ç–µ [Enter] –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è..."
done

log "üìÇ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è IaC..."
[[ ! -d "$IAC_DIR" ]] && git clone "$REPO_URL" "$IAC_DIR"
cd "$IAC_DIR" && git pull --rebase

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
if [[ -f "$IAC_DIR/system/packages.list" ]]; then
    log "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –∏–∑ IaC..."
    mapfile -t PKGS < <(grep -vE '^[[:space:]]*#|^[[:space:]]*$' "$IAC_DIR/system/packages.list")
    DEBIAN_FRONTEND=noninteractive apt-get install -y -qq "${PKGS[@]}"
fi

# ==============================================================================
# üì• –°–¢–ê–î–ò–Ø 2: –î–∞–Ω–Ω—ã–µ –∏ –ë—ç–∫–∞–ø
# ==============================================================================
log "üõ° –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤ ZT Bunker (apply-bunker-iac)..."
cp "$IAC_DIR/usr_local_bin/apply-bunker-iac" "/usr/local/bin/" && chmod 755 "/usr/local/bin/apply-bunker-iac"
/usr/local/bin/apply-bunker-iac --force

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ —Å Hetzner
STORAGE_HOST=$(grep -oE "[a-z0-9]+\.your-storagebox\.de" /etc/borgmatic/config.yaml | head -n1 || echo "")
if [[ -n "$STORAGE_HOST" ]]; then
    if ! ssh -p 23 -o BatchMode=yes "$STORAGE_HOST" "ls" &>/dev/null; then
        print_warning "–ù–µ—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ Hetzner Storage Box ($STORAGE_HOST)."
        read -rp "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–ø—É—Å–∫? (y/n) [y]: " CONTINUE_BORG
        [[ ! $CONTINUE_BORG =~ ^[Yy]$ ]] && exit 1
    fi
fi

if [[ -z "${BORG_PASSPHRASE:-}" ]]; then
    read -rs -p "–í–≤–µ–¥–∏—Ç–µ BORG_PASSPHRASE: " BORG_PASSPHRASE; export BORG_PASSPHRASE; echo ""
fi

# –ò–Ω—ä–µ–∫—Ü–∏—è –ø–∞—Ä–æ–ª—è
sed -i "s|^.*encryption_passphrase:.*$|    encryption_passphrase: \"$BORG_PASSPHRASE\"|" /etc/borgmatic/config.yaml

log "üîç –ü–æ–∏—Å–∫ –∞—Ä—Ö–∏–≤–æ–≤..."
export BORG_RSH="$BORG_SSH_COMMAND"
mapfile -t ARCHIVES < <(borgmatic list 2>&1 | grep -E "^[a-zA-Z0-9].*:[0-9]{4}-" | sort -r | head -n 5)
[[ ${#ARCHIVES[@]} -eq 0 ]] && error_exit "–ê—Ä—Ö–∏–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å."

for i in "${!ARCHIVES[@]}"; do echo "[$i] ${ARCHIVES[$i]}"; done
read -rp "üéØ –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –∞—Ä—Ö–∏–≤–∞ [0]: " ARCH_IDX; ARCH_IDX=${ARCH_IDX:-0}
SELECTED_ARCHIVE="${ARCHIVES[$ARCH_IDX]%% *}"

log "üì• –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–ø–æ–∫ –∏–∑ $SELECTED_ARCHIVE..."
borgmatic extract --archive "$SELECTED_ARCHIVE" --path opt etc/zt-bunker

# ==============================================================================
# üèó –°–¢–ê–î–ò–Ø 3: –í–æ—Å–∫—Ä–µ—à–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
# ==============================================================================
for ENTRY in "${RECOVERY_PLAN[@]}"; do
    IFS=':' read -r APP CONTAINER DUMP_FILE RESTORE_CMD <<< "$ENTRY"
    log "üöÄ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ $APP..."
    
    [[ ! -d "/opt/$APP" ]] && { print_warning "–ü–∞–ø–∫–∞ /opt/$APP –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤–µ!"; continue; }
    
    cd "/opt/$APP"
    docker-compose up -d
    wait_for_container "$CONTAINER"

    log "  üì• –ò–º–ø–æ—Ä—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    if [[ ! -f "/opt/$DUMP_FILE" ]]; then
        print_error "–î–∞–º–ø –±–∞–∑—ã $DUMP_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        continue
    fi

    if [[ "$DUMP_FILE" == *.gz ]]; then
        gunzip -c "/opt/$DUMP_FILE" | docker exec -i "$CONTAINER" sh -c "$RESTORE_CMD" || print_error "–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –±–∞–∑—ã $APP"
    else
        docker exec -i "$CONTAINER" sh -c "$RESTORE_CMD" < "/opt/$DUMP_FILE" || print_error "–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –±–∞–∑—ã $APP"
    fi
done

# ==============================================================================
# ‚úÖ –°–¢–ê–î–ò–Ø 4: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
# ==============================================================================
log "ü©∫ –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
HEALTH_CHECKS=(
    "n8n:localhost:5678/healthz"
    "Forgejo:localhost:3000"
)

for CHECK in "${HEALTH_CHECKS[@]}"; do
    IFS=':' read -r NAME URL <<< "$CHECK"
    if curl -s -f "http://$URL" > /dev/null; then
        print_success "$NAME: –î–û–°–¢–£–ü–ï–ù"
    else
        print_warning "$NAME: –ù–ï –û–¢–í–ï–ß–ê–ï–¢"
    fi
done

log "üéâ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
[[ -f "/usr/local/bin/telegram-send" ]] && /usr/local/bin/telegram-send "‚úÖ <b>ZT BUNKER: RECOVERY SUCCESS!</b>" || true
