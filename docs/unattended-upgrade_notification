# Настройка Email-оповещений для Unattended-Upgrades через msmtp (Gmail)

Эта инструкция описывает процесс настройки автоматических обновлений безопасности (unattended-upgrades) на Ubuntu/Debian с отправкой отчетов на email. В качестве MTA (Mail Transfer Agent) используется легковесный **msmtp**, а в качестве SMTP-сервера — **Google (Gmail)**.

## Предварительные требования
*   ОС: Ubuntu или Debian.
*   Права суперпользователя (root).
*   Аккаунт Google.

---

## Шаг 1: Настройка безопасности Google (App Password)

Google больше не позволяет использовать обычный пароль от аккаунта для сторонних приложений, если включена двухфакторная аутентификация (2FA). Необходимо создать **Пароль приложения**.

1.  Перейдите в управление аккаунтом Google: [https://myaccount.google.com/](https://myaccount.google.com/)
2.  Перейдите в раздел **Безопасность** -> **Двухэтапная аутентификация**.
3.  Прокрутите вниз до раздела "Пароли приложений" (App passwords).
4.  Создайте новый пароль:
    *   **Приложение:** "Другое" (назовите, например, `Ubuntu Server`).
    *   Нажмите **Создать**.
5.  Скопируйте полученный 16-значный пароль. Он понадобится на шаге 3.

---

## Шаг 2: Установка пакетов

Установим `msmtp`, пакет совместимости с MTA и `unattended-upgrades`.

```bash
sudo apt update
sudo apt install msmtp msmtp-mta bsd-mailx unattended-upgrades
```

*   `msmtp-mta` создает симлинк, чтобы системные вызовы `sendmail` перенаправлялись на `msmtp`.
*   `bsd-mailx` нужен для проверки отправки почты через консоль.

---

## Шаг 3: Настройка msmtp

Создадим глобальный конфигурационный файл, чтобы он был доступен для системных служб (root).

1.  Создайте файл `/etc/msmtprc`:

```bash
sudo nano /etc/msmtprc
```

2.  Вставьте следующее содержимое (замените данные на свои):

```conf
# Настройки по умолчанию
defaults
auth           on
tls            on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
logfile        /var/log/msmtp.log

# Настройки Gmail
account        gmail
host           smtp.gmail.com
port           587
from           ВАШ_EMAIL@gmail.com
user           ВАШ_EMAIL@gmail.com
password       ВАШ_ПАРОЛЬ_ПРИЛОЖЕНИЯ

# Установить аккаунт по умолчанию
account default : gmail
```

3.  Настройте права доступа (файл содержит пароль, поэтому доступ должен быть только у root):

```bash
sudo chmod 600 /etc/msmtprc
```

### Проверка отправки письма

Проверьте, работает ли отправка почты, выполнив команду:

```bash
echo "Test email content" | mail -s "Test Subject" ВАШ_EMAIL_КУДА_ПРИСЛАТЬ@example.com
```

*Если письмо пришло, переходите к следующему шагу. Если нет — проверьте `/var/log/msmtp.log`.*

---

## Шаг 4: Настройка Unattended-Upgrades

Теперь настроим саму службу обновлений на отправку отчетов.

1.  Откройте конфигурационный файл:

```bash
sudo nano /etc/apt/apt.conf.d/50unattended-upgrades
```

2.  Найдите и раскомментируйте (или добавьте) строку `Unattended-Upgrade::Mail`. Впишите туда email получателя:

```conf
// Укажите email, на который будут приходить отчеты
Unattended-Upgrade::Mail "ВАШ_EMAIL_КУДА_ПРИСЛАТЬ@example.com";
```

3.  *(Опционально)* Если вы хотите получать письма **только** в случае ошибок (чтобы не спамить успешными обновлениями), раскомментируйте и измените строку:

```conf
Unattended-Upgrade::MailOnlyOnError "true";
```
*Для тестирования лучше оставить это значение "false", а после проверки поменять на "true".*

---

## Шаг 5: Проверка работы (Dry Run)

Запустим `unattended-upgrades` в режиме отладки и "сухого запуска" (без реальной установки), чтобы убедиться, что система пытается отправить письмо.

Выполните команду:

```bash
sudo unattended-upgrade --dry-run --debug
```

Посмотрите на вывод в консоли. Вы должны увидеть строки, похожие на:

```text
...
Sending mail to '...'
...
```

Если обновлений нет, утилита может ничего не отправить. В таком случае можно принудительно заставить её "думать", что обновления есть, либо просто дождаться реального обновления.

### Проверка логов

После выполнения можно также проверить логи самого приложения:

```bash
cat /var/log/unattended-upgrades/unattended-upgrades.log
```

## Дополнительно: Настройка расписания

Убедитесь, что автоматические обновления включены в расписании:

```bash
sudo nano /etc/apt/apt.conf.d/20auto-upgrades
```

Файл должен выглядеть так:

```conf
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Unattended-Upgrade "1";
```

*   `"1"` означает выполнение каждый день.
